<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Complaint System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-10 text-blue-600">Student Complaint Management System</h1>
        <div class="flex flex-col md:flex-row justify-center gap-6 items-center h-[70vh]">
            <button onclick="showPage('student-login')" class="bg-blue-500 text-white px-8 py-4 rounded-lg hover:bg-blue-600 transition duration-300 text-xl">
                I'm a Student
            </button>
            <button onclick="showPage('admin-login')" class="bg-green-500 text-white px-8 py-4 rounded-lg hover:bg-green-600 transition duration-300 text-xl">
                I'm an Admin
            </button>
        </div>
    </div>

    <!-- Student Login Page -->
    <div id="student-login" class="hidden container mx-auto px-4 py-8">
        <button onclick="showPage('landing-page')" class="mb-4 text-blue-600"><i class="bi bi-arrow-left"></i> Back</button>
        <h2 class="text-2xl font-bold mb-6 text-center">Student Login</h2>
        <form id="student-login-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Student ID</label>
                <input type="text" id="student-id" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Password</label>
                <input type="password" id="student-password" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Login</button>
            <p class="mt-4 text-center">Don't have an account? <a href="#" onclick="showPage('student-register')" class="text-blue-500 hover:underline">Register here</a></p>
        </form>
    </div>

    <!-- Student Register Page -->
    <div id="student-register" class="hidden container mx-auto px-4 py-8">
        <button onclick="showPage('student-login')" class="mb-4 text-blue-600"><i class="bi bi-arrow-left"></i> Back</button>
        <h2 class="text-2xl font-bold mb-6 text-center">Student Registration</h2>
        <form id="student-register-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Full Name</label>
                <input type="text" id="student-name" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Email</label>
                <input type="email" id="student-email" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Student ID</label>
                <input type="text" id="register-student-id" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Password</label>
                <input type="password" id="register-student-password" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Register</button>
        </form>
    </div>

    <!-- Admin Login Page -->
    <div id="admin-login" class="hidden container mx-auto px-4 py-8">
        <button onclick="showPage('landing-page')" class="mb-4 text-blue-600"><i class="bi bi-arrow-left"></i> Back</button>
        <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
        <form id="admin-login-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Admin ID</label>
                <input type="text" id="admin-id" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Password</label>
                <input type="password" id="admin-password" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Login</button>
            <p class="mt-4 text-center">Don't have an account? <a href="#" onclick="showPage('admin-register')" class="text-green-500 hover:underline">Register here</a></p>
        </form>
    </div>

    <!-- Admin Register Page -->
    <div id="admin-register" class="hidden container mx-auto px-4 py-8">
        <button onclick="showPage('admin-login')" class="mb-4 text-blue-600"><i class="bi bi-arrow-left"></i> Back</button>
        <h2 class="text-2xl font-bold mb-6 text-center">Admin Registration</h2>
        <form id="admin-register-form" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Full Name</label>
                <input type="text" id="admin-name" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Email</label>
                <input type="email" id="admin-email" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Department</label>
                <input type="text" id="admin-department" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Admin ID</label>
                <input type="text" id="register-admin-id" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Password</label>
                <input type="password" id="register-admin-password" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Register</button>
        </form>
    </div>

    <!-- Student Dashboard -->
    <div id="student-dashboard" class="hidden container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="logout()" class="text-blue-600"><i class="bi bi-box-arrow-left"></i> Logout</button>
            <h2 class="text-2xl font-bold">Student Dashboard</h2>
            <button onclick="toggleComplaintForm()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">
                <i class="bi bi-plus-circle mr-1"></i> New Complaint
            </button>
        </div>

        <div id="student-info" class="bg-white p-4 rounded-lg shadow-md mb-6 max-w-4xl mx-auto">
            <h3 class="text-lg font-semibold mb-2">Welcome, <span id="student-name-display"></span></h3>
            <p>Student ID: <span id="student-id-display" class="font-medium"></span></p>
        </div>

        <!-- Complaint Form -->
        <div id="complaint-form" class="hidden max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Submit New Complaint</h3>
                <button onclick="toggleComplaintForm()" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="new-complaint-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Subject</label>
                    <input type="text" id="complaint-subject" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Department</label>
                    <select id="complaint-department" class="w-full px-3 py-2 border rounded-lg" required>
                        <option value="">Select department</option>
                        <option value="academic">Academic</option>
                        <option value="administrative">Administrative</option>
                        <option value="facilities">Facilities</option>
                        <option value="hostel">Hostel</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Description</label>
                    <textarea id="complaint-description" class="w-full px-3 py-2 border rounded-lg" rows="4" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="anonymous-checkbox" class="mr-2">
                        Submit Anonymously
                    </label>
                    <p class="text-xs text-gray-500 mt-1">Your identity will be hidden from other students and faculty members.</p>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Submit Complaint</button>
            </form>
        </div>

        <!-- Complaints List -->
        <div id="student-complaints-list" class="max-w-4xl mx-auto">
            <h3 class="text-xl font-bold mb-4">My Complaints</h3>
            <div id="complaints-filters" class="mb-4 flex flex-wrap gap-2">
                <button onclick="filterStudentComplaints('all')" class="px-3 py-1 rounded-lg bg-blue-100 text-blue-800">All</button>
                <button onclick="filterStudentComplaints('pending')" class="px-3 py-1 rounded-lg bg-yellow-100 text-yellow-800">Pending</button>
                <button onclick="filterStudentComplaints('in-progress')" class="px-3 py-1 rounded-lg bg-purple-100 text-purple-800">In Progress</button>
                <button onclick="filterStudentComplaints('resolved')" class="px-3 py-1 rounded-lg bg-green-100 text-green-800">Resolved</button>
            </div>
            <div id="complaints-container" class="space-y-4">
                <div class="flex justify-center items-center py-8 text-gray-500">
                    Loading complaints...
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <button onclick="logout()" class="text-green-600"><i class="bi bi-box-arrow-left"></i> Logout</button>
            <h2 class="text-2xl font-bold">Admin Dashboard</h2>
        </div>

        <div id="admin-info" class="bg-white p-4 rounded-lg shadow-md mb-6 max-w-4xl mx-auto">
            <h3 class="text-lg font-semibold mb-2">Welcome, <span id="admin-name-display"></span></h3>
            <p>Department: <span id="admin-department-display" class="font-medium"></span></p>
        </div>

        <!-- Admin Complaints List -->
        <div id="admin-complaints-list" class="max-w-4xl mx-auto">
            <h3 class="text-xl font-bold mb-4">All Complaints</h3>
            <div id="admin-complaints-filters" class="mb-4 flex flex-wrap gap-2">
                <button onclick="filterAdminComplaints('all')" class="px-3 py-1 rounded-lg bg-blue-100 text-blue-800">All</button>
                <button onclick="filterAdminComplaints('pending')" class="px-3 py-1 rounded-lg bg-yellow-100 text-yellow-800">Pending</button>
                <button onclick="filterAdminComplaints('in-progress')" class="px-3 py-1 rounded-lg bg-purple-100 text-purple-800">In Progress</button>
                <button onclick="filterAdminComplaints('resolved')" class="px-3 py-1 rounded-lg bg-green-100 text-green-800">Resolved</button>
            </div>
            <div id="admin-complaints-container" class="space-y-4">
                <div class="flex justify-center items-center py-8 text-gray-500">
                    Loading complaints...
                </div>
            </div>
        </div>
    </div>

    <script>
        const appSlug = 'complaint-system-123456';
        let currentUser = null;
        let studentComplaints = [];
        let adminComplaints = [];
        let currentStudentFilter = 'all';
        let currentAdminFilter = 'all';

        // Show loading animation
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        // Hide loading animation
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('div[id$="-page"], div[id$="-dashboard"], div[id$="-register"], div[id$="-login"]').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        function toggleComplaintForm() {
            const form = document.getElementById('complaint-form');
            form.classList.toggle('hidden');
        }

        function logout() {
            currentUser = null;
            showPage('landing-page');
        }

        // Student Registration
        document.getElementById('student-register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const name = document.getElementById('student-name').value;
            const email = document.getElementById('student-email').value;
            const studentId = document.getElementById('register-student-id').value;
            const password = document.getElementById('register-student-password').value;

            try {
                // Check if student already exists
                const checkResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'students',
                        conditions: { studentId }
                    })
                });

                const checkData = await checkResponse.json();
                
                if (checkData.result && checkData.result.length > 0) {
                    alert('Student ID already exists. Please use a different ID or login.');
                    hideLoading();
                    return;
                }

                // Create new student
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'create',
                        collection: 'students',
                        data: {
                            name,
                            email,
                            studentId,
                            password, // In a real app, this should be hashed
                            createdAt: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    alert('Registration successful! Please login.');
                    document.getElementById('student-register-form').reset();
                    showPage('student-login');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
            
            hideLoading();
        });

        // Admin Registration
        document.getElementById('admin-register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const name = document.getElementById('admin-name').value;
            const email = document.getElementById('admin-email').value;
            const department = document.getElementById('admin-department').value;
            const adminId = document.getElementById('register-admin-id').value;
            const password = document.getElementById('register-admin-password').value;

            try {
                // Check if admin already exists
                const checkResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'admins',
                        conditions: { adminId }
                    })
                });

                const checkData = await checkResponse.json();
                
                if (checkData.result && checkData.result.length > 0) {
                    alert('Admin ID already exists. Please use a different ID or login.');
                    hideLoading();
                    return;
                }

                // Create new admin
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'create',
                        collection: 'admins',
                        data: {
                            name,
                            email,
                            department,
                            adminId,
                            password, // In a real app, this should be hashed
                            createdAt: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    alert('Registration successful! Please login.');
                    document.getElementById('admin-register-form').reset();
                    showPage('admin-login');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
            
            hideLoading();
        });

        // Student Login
        document.getElementById('student-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const studentId = document.getElementById('student-id').value;
            const password = document.getElementById('student-password').value;

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'students',
                        conditions: { studentId, password }
                    })
                });

                const data = await response.json();
                
                if (data.result && data.result.length > 0) {
                    currentUser = data.result[0];
                    currentUser.role = 'student';
                    
                    // Display user info
                    document.getElementById('student-name-display').textContent = currentUser.name;
                    document.getElementById('student-id-display').textContent = currentUser.studentId;
                    
                    showPage('student-dashboard');
                    loadStudentComplaints();
                } else {
                    alert('Invalid credentials. Please try again.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
            
            hideLoading();
        });

        // Admin Login
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const adminId = document.getElementById('admin-id').value;
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'admins',
                        conditions: { adminId, password }
                    })
                });

                const data = await response.json();
                
                if (data.result && data.result.length > 0) {
                    currentUser = data.result[0];
                    currentUser.role = 'admin';
                    
                    // Display user info
                    document.getElementById('admin-name-display').textContent = currentUser.name;
                    document.getElementById('admin-department-display').textContent = currentUser.department;
                    
                    showPage('admin-dashboard');
                    loadAllComplaints();
                } else {
                    alert('Invalid credentials. Please try again.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
            
            hideLoading();
        });

        // Submit New Complaint
        document.getElementById('new-complaint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const subject = document.getElementById('complaint-subject').value;
            const department = document.getElementById('complaint-department').value;
            const description = document.getElementById('complaint-description').value;
            const isAnonymous = document.getElementById('anonymous-checkbox').checked;

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'create',
                        collection: 'complaints',
                        data: {
                            subject,
                            department,
                            description,
                            studentId: currentUser.studentId,
                            studentName: currentUser.name,
                            anonymous: isAnonymous,
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            comments: []
                        }
                    })
                });

                if (response.ok) {
                    alert('Complaint submitted successfully!');
                    document.getElementById('new-complaint-form').reset();
                    toggleComplaintForm();
                    loadStudentComplaints();
                }
            } catch (error) {
                console.error('Complaint submission error:', error);
                alert('Complaint submission failed. Please try again.');
            }
            
            hideLoading();
        });

        // Filter Student Complaints
        function filterStudentComplaints(status) {
            currentStudentFilter = status;
            renderStudentComplaints();

            // Update active filter UI
            document.querySelectorAll('#complaints-filters button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-800');
            });
            
            if (status === 'all') {
                document.querySelector('button[onclick="filterStudentComplaints(\'all\')"]').classList.remove('bg-blue-100', 'text-blue-800');
                document.querySelector('button[onclick="filterStudentComplaints(\'all\')"]').classList.add('bg-blue-500', 'text-white');
            } else if (status === 'pending') {
                document.querySelector('button[onclick="filterStudentComplaints(\'pending\')"]').classList.remove('bg-yellow-100', 'text-yellow-800');
                document.querySelector('button[onclick="filterStudentComplaints(\'pending\')"]').classList.add('bg-yellow-500', 'text-white');
            } else if (status === 'in-progress') {
                document.querySelector('button[onclick="filterStudentComplaints(\'in-progress\')"]').classList.remove('bg-purple-100', 'text-purple-800');
                document.querySelector('button[onclick="filterStudentComplaints(\'in-progress\')"]').classList.add('bg-purple-500', 'text-white');
            } else if (status === 'resolved') {
                document.querySelector('button[onclick="filterStudentComplaints(\'resolved\')"]').classList.remove('bg-green-100', 'text-green-800');
                document.querySelector('button[onclick="filterStudentComplaints(\'resolved\')"]').classList.add('bg-green-500', 'text-white');
            }
        }

        // Filter Admin Complaints
        function filterAdminComplaints(status) {
            currentAdminFilter = status;
            renderAdminComplaints();

            // Update active filter UI
            document.querySelectorAll('#admin-complaints-filters button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-800');
            });
            
            if (status === 'all') {
                document.querySelector('button[onclick="filterAdminComplaints(\'all\')"]').classList.remove('bg-blue-100', 'text-blue-800');
                document.querySelector('button[onclick="filterAdminComplaints(\'all\')"]').classList.add('bg-blue-500', 'text-white');
            } else if (status === 'pending') {
                document.querySelector('button[onclick="filterAdminComplaints(\'pending\')"]').classList.remove('bg-yellow-100', 'text-yellow-800');
                document.querySelector('button[onclick="filterAdminComplaints(\'pending\')"]').classList.add('bg-yellow-500', 'text-white');
            } else if (status === 'in-progress') {
                document.querySelector('button[onclick="filterAdminComplaints(\'in-progress\')"]').classList.remove('bg-purple-100', 'text-purple-800');
                document.querySelector('button[onclick="filterAdminComplaints(\'in-progress\')"]').classList.add('bg-purple-500', 'text-white');
            } else if (status === 'resolved') {
                document.querySelector('button[onclick="filterAdminComplaints(\'resolved\')"]').classList.remove('bg-green-100', 'text-green-800');
                document.querySelector('button[onclick="filterAdminComplaints(\'resolved\')"]').classList.add('bg-green-500', 'text-white');
            }
        }

        // Load Student's Complaints
        async function loadStudentComplaints() {
            showLoading();
            
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'complaints',
                        conditions: {
                            studentId: currentUser.studentId
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    studentComplaints = data.result || [];
                    renderStudentComplaints();
                }
            } catch (error) {
                console.error('Error loading complaints:', error);
                document.getElementById('complaints-container').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg text-red-800">
                        Failed to load complaints. Please try refreshing the page.
                    </div>
                `;
            }
            
            hideLoading();
        }

        // Render Student Complaints with filters
        function renderStudentComplaints() {
            const container = document.getElementById('complaints-container');
            
            // Filter complaints based on selected status
            let filteredComplaints = studentComplaints;
            if (currentStudentFilter !== 'all') {
                filteredComplaints = studentComplaints.filter(complaint => complaint.status === currentStudentFilter);
            }
            
            if (filteredComplaints.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-50 p-8 rounded-lg text-center text-gray-500">
                        <i class="bi bi-inbox text-4xl mb-2"></i>
                        <p>No complaints found${currentStudentFilter !== 'all' ? ' with this status' : ''}.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            filteredComplaints.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = filteredComplaints.map(complaint => `
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
                        <h4 class="font-bold text-lg">${complaint.subject}</h4>
                        <span class="px-3 py-1 rounded-full text-sm mt-2 md:mt-0 ${getStatusColorClass(complaint.status)}">${getStatusLabel(complaint.status)}</span>
                    </div>
                    <p class="text-gray-600 mt-2 mb-3">${complaint.description}</p>
                    <div class="bg-gray-50 p-3 rounded-md text-sm">
                        <p><span class="font-medium">Department:</span> ${complaint.department || 'Not specified'}</p>
                        <p class="mt-1"><span class="font-medium">Submitted:</span> ${formatDate(complaint.createdAt)}</p>
                        ${complaint.anonymous ? '<p class="mt-1 text-gray-500 italic">Submitted anonymously</p>' : ''}
                    </div>
                    
                    ${complaint.comments && complaint.comments.length > 0 ? `
                        <div class="mt-4">
                            <h5 class="font-semibold mb-2">Comments</h5>
                            <div class="space-y-2">
                                ${complaint.comments.map(comment => `
                                    <div class="bg-blue-50 p-3 rounded-md">
                                        <p>${comment.text}</p>
                                        <p class="text-xs text-gray-500 mt-1">By ${comment.by} on ${formatDate(comment.date)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Load All Complaints (Admin)
        async function loadAllComplaints() {
            showLoading();
            
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'complaints'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    adminComplaints = data.result || [];
                    renderAdminComplaints();
                }
            } catch (error) {
                console.error('Error loading complaints:', error);
                document.getElementById('admin-complaints-container').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg text-red-800">
                        Failed to load complaints. Please try refreshing the page.
                    </div>
                `;
            }
            
            hideLoading();
        }

        // Render Admin Complaints with filters
        function renderAdminComplaints() {
            const container = document.getElementById('admin-complaints-container');
            
            // Filter complaints based on selected status
            let filteredComplaints = adminComplaints;
            if (currentAdminFilter !== 'all') {
                filteredComplaints = adminComplaints.filter(complaint => complaint.status === currentAdminFilter);
            }
            
            if (filteredComplaints.length === 0) {
                container.innerHTML = `
                    <div class="bg-gray-50 p-8 rounded-lg text-center text-gray-500">
                        <i class="bi bi-inbox text-4xl mb-2"></i>
                        <p>No complaints found${currentAdminFilter !== 'all' ? ' with this status' : ''}.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            filteredComplaints.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            container.innerHTML = filteredComplaints.map(complaint => `
                <div class="bg-white p-5 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
                        <h4 class="font-bold text-lg">${complaint.subject}</h4>
                        <select onchange="updateComplaintStatus('${complaint._id}', this.value)" class="px-3 py-1 rounded-lg border mt-2 md:mt-0 ${getStatusSelectClass(complaint.status)}">
                            <option value="pending" ${complaint.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${complaint.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="resolved" ${complaint.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                        </select>
                    </div>
                    <p class="text-gray-600 mt-2 mb-3">${complaint.description}</p>
                    <div class="bg-gray-50 p-3 rounded-md text-sm">
                        <p><span class="font-medium">Department:</span> ${complaint.department || 'Not specified'}</p>
                        <p class="mt-1"><span class="font-medium">Submitted:</span> ${formatDate(complaint.createdAt)}</p>
                        <p class="mt-1"><span class="font-medium">From:</span> ${complaint.anonymous ? 'Anonymous' : complaint.studentName}</p>
                        <p class="mt-1"><span class="font-medium">Student ID:</span> ${complaint.anonymous ? 'Hidden' : complaint.studentId}</p>
                    </div>
                    
                    ${complaint.comments && complaint.comments.length > 0 ? `
                        <div class="mt-4">
                            <h5 class="font-semibold mb-2">Comments</h5>
                            <div class="space-y-2">
                                ${complaint.comments.map(comment => `
                                    <div class="bg-blue-50 p-3 rounded-md">
                                        <p>${comment.text}</p>
                                        <p class="text-xs text-gray-500 mt-1">By ${comment.by} on ${formatDate(comment.date)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4">
                        <h5 class="font-semibold mb-2">Add Comment</h5>
                        <form onsubmit="event.preventDefault(); addComment('${complaint._id}')">
                            <div class="flex gap-2">
                                <input type="text" id="comment-${complaint._id}" class="flex-grow px-3 py-2 border rounded-lg">
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `).join('');
        }

        // Add comment to complaint
        async function addComment(complaintId) {
            const commentInput = document.getElementById(`comment-${complaintId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                alert('Please enter a comment before submitting.');
                return;
            }
            
            showLoading();
            
            try {
                // First get current complaint to access comments array
                const getResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'complaints',
                        conditions: { _id: complaintId }
                    })
                });
                
                const getData = await getResponse.json();
                const complaint = getData.result[0];
                
                // Update comments array
                const comments = complaint.comments || [];
                comments.push({
                    text: commentText,
                    by: `Admin (${currentUser.name})`,
                    date: new Date().toISOString()
                });
                
                // Update complaint
                const updateResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'complaints',
                        conditions: { _id: complaintId },
                        data: { comments }
                    })
                });

                if (updateResponse.ok) {
                    commentInput.value = '';
                    loadAllComplaints();
                }
            } catch (error) {
                console.error('Error adding comment:', error);
                alert('Failed to add comment. Please try again.');
            }
            
            hideLoading();
        }

        // Update Complaint Status (Admin)
        async function updateComplaintStatus(complaintId, status) {
            showLoading();
            
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'complaints',
                        conditions: { _id: complaintId },
                        data: { status }
                    })
                });

                if (response.ok) {
                    // Add automatic comment about status change
                    const getResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'complaints',
                            conditions: { _id: complaintId }
                        })
                    });
                    
                    const getData = await getResponse.json();
                    const complaint = getData.result[0];
                    
                    // Update comments array
                    const comments = complaint.comments || [];
                    comments.push({
                        text: `Status updated to "${getStatusLabel(status)}"`,
                        by: `Admin (${currentUser.name})`,
                        date: new Date().toISOString()
                    });
                    
                    // Update complaint with new comment
                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ckY269Ss4TPD2sCRiEKpIblw3m62',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'complaints',
                            conditions: { _id: complaintId },
                            data: { comments }
                        })
                    });
                    
                    loadAllComplaints();
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Please try again.');
            }
            
            hideLoading();
        }

        // Helper Functions
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function getStatusLabel(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'in-progress': return 'In Progress';
                case 'resolved': return 'Resolved';
                default: return status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        function getStatusColorClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'in-progress': return 'bg-purple-100 text-purple-800';
                case 'resolved': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusSelectClass(status) {
            switch (status) {
                case 'pending': return 'border-yellow-300 bg-yellow-50';
                case 'in-progress': return 'border-purple-300 bg-purple-50';
                case 'resolved': return 'border-green-300 bg-green-50';
                default: return '';
            }
        }
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>